version: v1.0

name: oberan.dev

agent:
  machine:
    type: e2-standard-2
    os_image: ubuntu2204

auto_cancel:
  queued:
    when: "true"

blocks:
  - name: "\U0001F4E6 Install dependencies"
    task:
      env_vars:
        - name: MIX_ENV
          value: test
        - name: NODE_ENV
          value: test
        - name: CI
          value: "true"
      prologue:
        commands:
          - checkout
      jobs:
        - name: mix deps.get and cache
          commands:
            - sem-version elixir 1.15
            - cache restore
            - mix deps.get
            - mix compile
            - cache store

        - name: yarn install and cache
          commands:
            - sem-version node 20
            - cd assets
            - cache restore
            - yarn install
            - cache store

  - name: "\U0001F50D Static Analysis"
    task:
      env_vars:
        - name: MIX_ENV
          value: test
        - name: NODE_ENV
          value: test
        - name: CI
          value: "true"
      prologue:
        commands:
          - checkout
      jobs:
        - name: format & lint (elixir)
          commands:
            - sem-version elixir 1.15
            - cache restore
            - mix format --check-formatted
            - mix credo

        - name: format & lint (javascript)
          commands:
            - sem-version node 20
            - cd assets
            - cache restore
            - yarn format:check
            - yarn lint

  - name: "\U0001F9EA Unit Tests"
    task:
      env_vars:
        - name: MIX_ENV
          value: test
        - name: NODE_ENV
          value: test
        - name: CI
          value: "true"
      prologue:
        commands:
          - checkout
      jobs:
        - name: phoenix (elixir)
          commands:
            - sem-version elixir 1.15
            - cache restore
            - curl -Os https://uploader.codecov.io/latest/linux/codecov
            - chmod +x codecov
            - mix coveralls
            - ./codecov

  - name: "\U0001F52C E2E Tests"
    task:
      env_vars:
        - name: MIX_ENV
          value: test
        - name: NODE_ENV
          value: test
        - name: CI
          value: "true"
      prologue:
        commands:
          - checkout
      jobs:
        - name: playwright
          commands:
            - echo "coming soon..."
