version: v1.0

name: oberan.dev

agent:
  machine:
    type: e2-standard-2
    os_image: ubuntu2204

auto_cancel:
  queued:
    when: "true"

blocks:
  - name: "\U0001F4E6 Install dependencies"
    task:
      env_vars:
        - name: MIX_ENV
          value: test
        - name: NODE_ENV
          value: test
      prologue:
        commands:
          - checkout
      jobs:
        - name: mix deps.get
          commands:
            - scripts/setup_ci_elixir.sh
            - sem-version elixir 1.14
            - cache restore
            - mix deps.get
            - mix compile --warnings-as-errors
            - cache store
        - name: pnpm install
          commands:
            - sem-version node 20
            - corepack enable
            - corepack prepare pnpm@latest-8 --activate
            - cd assets
            - cache restore
            - pnpm install
            - cache store

  - name: "\U0001F50D Static Analysis"
    task:
      env_vars:
        - name: MIX_ENV
          value: test
        - name: NODE_ENV
          value: test
      prologue:
        commands:
          - checkout
      jobs:
        - name: format & lint (elixir)
          commands:
            - scripts/setup_ci_elixir.sh
            - sem-version elixir 1.14
            - cache restore
            - mix format --check-formatted
            - mix credo

        - name: hex.pm audit (elixir)
          commands:
            - scripts/setup_ci_elixir.sh
            - sem-version elixir 1.14
            - cache restore
            - mix hex.audit

        - name: no unused deps (elixir)
          commands:
            - scripts/setup_ci_elixir.sh
            - sem-version elixir 1.14
            - cache restore
            - mix deps.unlock --check-unused

        - name: format & lint (javascript)
          commands:
            - sem-version node 20
            - cd assets
            - cache restore
            - pnpm format:check
            - pnpm lint

  - name: "\U0001F9EA Unit Tests"
    task:
      env_vars:
        - name: MIX_ENV
          value: test
        - name: NODE_ENV
          value: test
      secrets:
        - name: codecov
      prologue:
        commands:
          - checkout
      jobs:
        - name: ex_unit
          commands:
            - scripts/setup_ci_elixir.sh
            - sem-version elixir 1.14
            - cache restore
            - curl -Os https://uploader.codecov.io/latest/linux/codecov
            - chmod +x codecov
            - mix coveralls.json
            - ./codecov

  - name: "\U0001F52C E2E Tests"
    task:
      env_vars:
        - name: MIX_ENV
          value: test
        - name: NODE_ENV
          value: test
      prologue:
        commands:
          - checkout
      jobs:
        - name: playwright
          commands:
            - echo "coming soon..."

promotions:
  - name: Production deploy
    pipeline_file: production-deploy.yml
    auto_promote:
      when: "result = 'passed' and branch = 'main'"
